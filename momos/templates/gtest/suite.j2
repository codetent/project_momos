#include <iostream>
#include <gtest/gtest.h>

#include "momos/io.hpp"
#include "momos/macros.hpp"

{% for include in includes %}
#include "{{ include }}"
{% endfor %}


#define WARN(x) std::cerr << "[     WARN ] " << x << std::endl


class StateTest : public ::testing::Test
{
protected:
    void SetUp() override
    {
        io::in.reset();
        io::out.reset();

        HOOK_RUN(init);
        HOOK_RUN(update);
    }

    void TearDown() override
    {
        HOOK_RUN(deinit);
    }
};

{% for case in suite.cases %}
{% set last_step = case.steps[-1] %}
TEST_F(StateTest, {{ last_step.transition.from_state.id }}__{{ last_step.transition.to_state.id }}__{{ case.mode.description | pascalcase }})
{
    {% for step in case.steps %}
    {% set from_state = step.transition.from_state %}
    {% set to_state = step.transition.to_state %}
    {% set step_index = loop.index %}

    // [Step {{ step_index }}]: {{ step.description }} ----------
    ASSERT_EQ(STATE_GET(), {{ from_state.id }});

    {% for arg in step.arguments %}
    {% set arg_name = 'arg_' ~ step_index ~ '_' ~ loop.index %}
    double {{ arg_name }} = {{ arg | default('0', true) }};
    if (!TRANSITION_RUN({{ from_state.id }}, {{ to_state.id }}, &{{ arg_name }}))
    {
        WARN("Transition undefined for {{ from_state.id }} -> {{ to_state.id }}");
    }
    HOOK_RUN(update);
    {% endfor %}

    {% if step.mode.fails %}
    ASSERT_NE(STATE_GET(), {{ to_state.id }});
    {% else %}
    ASSERT_EQ(STATE_GET(), {{ to_state.id }});
    {% endif %}

    CHECK_RUN({{ from_state.id }}, {{ to_state.id }});

    {% endfor %}
}

{% endfor %}


int main(int argc, char **argv) {
    ::testing::InitGoogleTest(&argc, argv);
    return RUN_ALL_TESTS();
}
